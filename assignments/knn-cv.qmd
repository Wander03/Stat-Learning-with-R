---
title: "Assignment 2: Cross-Validation and K-Nearest-Neighbors"
author: "Andrew Kerr"
format: 
  html:
    code-fold: true
    code-line-numbers: true
    code-tools: true
    embed-resources: true
editor: source
---

```{r}
#| label: packages
#| message: false
#| warning: false

set.seed(3849)

library(tidyverse)
library(tidymodels)
library(kableExtra)
```

# Instructions

Your document should also be clearly organized, so that it is easy for a reader to find your answers to each question. If I have a difficult time locating or reading your answer, you risk it being returned with a "revision requested".

# The Data

```{r}
#| label: load-data
#| message: false
whr_clean <- read_csv(here::here('data', 'whr_clean.csv'))

whr_clean <- whr_clean %>%
  mutate(
    regional_indicator = as_factor(regional_indicator)
  )

whr_clean %>% summary() %>% kable()
```

```{r}
#| label: cleaning NA

whr_clean %>%
  filter(if_any(everything(), is.na))

whr_clean <- whr_clean %>%
  mutate(
    regional_indicator = case_when(
      is.na(regional_indicator) ~ "Other",
      TRUE ~ regional_indicator
    ),
    log_gdp_per_capita = case_when(
      is.na(log_gdp_per_capita) ~ mean(log_gdp_per_capita, na.rm = TRUE),
      TRUE ~ log_gdp_per_capita
    ),
    healthy_life_expectancy = case_when(
      is.na(healthy_life_expectancy) ~ mean(healthy_life_expectancy, na.rm = TRUE),
      TRUE ~ healthy_life_expectancy
    ),
    social_support = case_when(
      is.na(social_support) ~ mean(social_support, na.rm = TRUE),
      TRUE ~ social_support
    ),
    freedom_to_make_life_choices = case_when(
      is.na(freedom_to_make_life_choices) ~ mean(freedom_to_make_life_choices, na.rm = TRUE),
      TRUE ~ freedom_to_make_life_choices
    ),
    generosity = case_when(
      is.na(generosity) ~ mean(generosity, na.rm = TRUE),
      TRUE ~ generosity
    ),
    perceptions_of_corruption = case_when(
      is.na(perceptions_of_corruption) ~ mean(perceptions_of_corruption, na.rm = TRUE),
      TRUE ~ perceptions_of_corruption
    ),
    regional_indicator = as_factor(regional_indicator)
  )
```

# Happiness Scores

## Part 1: Happiness Over Time

1.  Is the happiness in the world changing linearly over time? Fit a simple linear model and interpret the results to address this question.

```{r}
#| label: Q1

lin_reg <- linear_reg() %>%
  set_engine("lm") %>%
  set_mode("regression")

lr_m1 <- lin_reg %>%
  fit(happiness_score ~ year, data = whr_clean)

whr_clean <- whr_clean %>%
  mutate(
    prediction = predict(lr_m1, new_data = whr_clean)$.pred,
    residuals = happiness_score - prediction
    )

glance(lr_m1) %>% kable()
tidy(lr_m1) %>% kable()

whr_clean %>%
  ggplot(aes(x = happiness_score, y = residuals)) +
    geom_point() +
    theme_bw()
```

The happiness in the world is not changing linearly over time since we see a low $R^2$ value of approx. 0, and a large p-value for the year coefficient. Additionally, the residual plot shows a linear pattern, meaning we are using the wrong model.

2.  Was the happiness score approximately the same in all the years? Convert `year` to a factor variable, and fit a simple linear model to address this question.

```{r}
#| label: Q2

whr_clean <- whr_clean %>%
  mutate(year = as_factor(year))

lr_m2 <- lin_reg %>%
  fit(happiness_score ~ year, data = whr_clean)

tidy(lr_m2) %>% kable()
```

No, the happiness score was not approx. the same in all the years. We see highly significant p-values for all years compared to the baseline year of 2005, with 2005 being on average around 1 unit of happiness score greater than all the other years.

## Part 2: Happiness Equation

3.  How is each of the six measures of life quality weighted in calculating this score? Fit a model to estimate the weights, and interpret the coefficients.

```{r}
#| label: Q3

lr_recipe <- recipe(
  happiness_score ~ log_gdp_per_capita 
  + healthy_life_expectancy 
  + social_support 
  + freedom_to_make_life_choices 
  + generosity 
  + perceptions_of_corruption,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

lr_wrkflw <- workflow() %>%
  add_recipe(lr_recipe) %>%
  add_model(lin_reg)

lr_wrkflw  %>%
  fit(whr_clean) %>%
  extract_fit_parsnip()
```

-   intercept: When all predictors are at there minimum values, the average happiness score is 5.46.
-   log_gdp_per_capita: If log GDP per capita moves from its lowest observed value to its highest, the average happiness score increases by 0.41 units.
-   healthy_life_expectancy: Moving from the lowest observed life expectancy to the highest, the average happiness score increases by 0.23 units.
-   social_support: Moving from the lowest observed social support to the highest, the average happiness score increases by 0.28 units.
-   freedom_to_make_life_choices: If freedom to make life choices moves from its lowest observed value to its highest, the average happiness score increases by 0.16 units.
-   generosity: If the generosity of society moves from its lowest observed value to its highest, the average happiness score increases by 0.11 units.
-   perceptions_of_corruption: If perceptions of corruption in government moves from its lowest observed value to its highest, the average happiness score decreases by 0.09 units.

4.  Which measures of life quality does the WHR consider to be most important to a country's happiness?

Log GDP per capita is the most important to a country's happiness since it has the larges coefficient, followed by social support and healthy life expectancy.

# Predicting Life Expectancy -- Exploring Linear Models

```{r}
#| label: pred-life-expectancy

whr_clean[, c(4, 6:9)] %>% cor()

whr_cvs <- vfold_cv(whr_clean, v = 10)

base_recipe <- recipe(
  healthy_life_expectancy ~ log_gdp_per_capita 
  + social_support 
  + freedom_to_make_life_choices 
  + generosity 
  + perceptions_of_corruption
  + regional_indicator,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

life_wrkflw <- workflow() %>%
  add_recipe(base_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: full-model

full_recipe <- base_recipe %>%
  step_interact(terms = ~ log_gdp_per_capita:social_support +
                 log_gdp_per_capita:freedom_to_make_life_choices +
                 log_gdp_per_capita:generosity +
                 log_gdp_per_capita:perceptions_of_corruption +
                 log_gdp_per_capita:regional_indicator +
                 social_support:freedom_to_make_life_choices +
                 social_support:generosity +
                 social_support:perceptions_of_corruption +
                 social_support:regional_indicator +
                 freedom_to_make_life_choices:generosity +
                 freedom_to_make_life_choices:perceptions_of_corruption +
                 freedom_to_make_life_choices:regional_indicator +
                 generosity:perceptions_of_corruption +
                 generosity:regional_indicator +
                 perceptions_of_corruption:regional_indicator
               )

life_wrkflw <- workflow() %>%
  add_recipe(full_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: gdp-models

gdp_recipe <- recipe(
  healthy_life_expectancy ~ log_gdp_per_capita,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

gdp_2_recipe <- gdp_recipe %>%
  step_poly(log_gdp_per_capita, degree = 2)

life_wrkflw <- workflow() %>%
  add_recipe(gdp_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

life_wrkflw <- workflow() %>%
  add_recipe(gdp_2_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: social-models

social_recipe <- recipe(
  healthy_life_expectancy ~ social_support,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

social_2_recipe <- social_recipe %>%
  step_poly(social_support, degree = 2)

life_wrkflw <- workflow() %>%
  add_recipe(social_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

life_wrkflw <- workflow() %>%
  add_recipe(social_2_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: freedom-models

gdp_recipe <- recipe(
  healthy_life_expectancy ~ freedom_to_make_life_choices,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

gdp_2_recipe <- gdp_recipe %>%
  step_poly(freedom_to_make_life_choices, degree = 2)

life_wrkflw <- workflow() %>%
  add_recipe(gdp_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

life_wrkflw <- workflow() %>%
  add_recipe(gdp_2_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: generosity-models

gdp_recipe <- recipe(
  healthy_life_expectancy ~ generosity,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

gdp_2_recipe <- gdp_recipe %>%
  step_poly(generosity, degree = 2)

life_wrkflw <- workflow() %>%
  add_recipe(gdp_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

life_wrkflw <- workflow() %>%
  add_recipe(gdp_2_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: corruption-models

gdp_recipe <- recipe(
  healthy_life_expectancy ~ perceptions_of_corruption,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

gdp_2_recipe <- gdp_recipe %>%
  step_poly(perceptions_of_corruption, degree = 2)

life_wrkflw <- workflow() %>%
  add_recipe(gdp_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

life_wrkflw <- workflow() %>%
  add_recipe(gdp_2_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: region-models

gdp_recipe <- recipe(
  healthy_life_expectancy ~ regional_indicator,
  data = whr_clean
  )

life_wrkflw <- workflow() %>%
  add_recipe(gdp_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: reduced-model

reduced_recipe <- recipe(
  healthy_life_expectancy ~ log_gdp_per_capita 
  + freedom_to_make_life_choices 
  + generosity 
  + regional_indicator,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_dummy(regional_indicator)

life_wrkflw <- workflow() %>%
  add_recipe(reduced_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

```{r}
#| label: reduced-interaction-model

reduced_2_recipe <- reduced_recipe %>%
  step_interact(term = ~ log_gdp_per_capita:freedom_to_make_life_choices
                + freedom_to_make_life_choices:generosity)

life_wrkflw <- workflow() %>%
  add_recipe(reduced_2_recipe) %>%
  add_model(lin_reg)

life_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()
```

## Part 1: Summary of Approach

6.  Write a short description (bullet points are fine) of your process in narrowing down your model. How did you approach this problem, without spending hours upon hours fitting and cross-validating zillions of models?

- All models were fit using 10-Fold CV
- I created a main effects and full (all two-way interaction) model
- I created a model for each predictor, as well as their 2nd order poly term
- I looked a the correlation between each quantitative predictor
- GDP and social support have a correlation of .68 and freedom to make choices
and perceptions of corruption have a correlation of -.48. Thus, I removed the 
two predictors with smaller $R^2$ values in there single predictor models from 
my main effects model (-social support and -corruption)
- I tried adding the interactions of somewhat correlated values to my reduced 
model to see if they would improve the model.

## Part 2: Three Candidates

8.  Choose the three best candidate models among those you tried.

- full model
- reduced model
- reduced interaction model

9.  Supply your code and results for comparing these models, and discuss how you decided which *one* model was the best one.

```{r}
#| label: Q9

full_recipe <- base_recipe %>%
  step_interact(terms = ~ log_gdp_per_capita:social_support +
                 log_gdp_per_capita:freedom_to_make_life_choices +
                 log_gdp_per_capita:generosity +
                 log_gdp_per_capita:perceptions_of_corruption +
                 log_gdp_per_capita:regional_indicator +
                 social_support:freedom_to_make_life_choices +
                 social_support:generosity +
                 social_support:perceptions_of_corruption +
                 social_support:regional_indicator +
                 freedom_to_make_life_choices:generosity +
                 freedom_to_make_life_choices:perceptions_of_corruption +
                 freedom_to_make_life_choices:regional_indicator +
                 generosity:perceptions_of_corruption +
                 generosity:regional_indicator +
                 perceptions_of_corruption:regional_indicator
               )

reduced_recipe <- recipe(
  healthy_life_expectancy ~ log_gdp_per_capita 
  + freedom_to_make_life_choices 
  + generosity 
  + regional_indicator,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_dummy(regional_indicator)

reduced_2_recipe <- reduced_recipe %>%
  step_interact(term = ~ log_gdp_per_capita:freedom_to_make_life_choices
                + freedom_to_make_life_choices:generosity)


full_wrkflw <- workflow() %>%
  add_recipe(full_recipe) %>%
  add_model(lin_reg)

reduced_wrkflw <- workflow() %>%
  add_recipe(reduced_recipe) %>%
  add_model(lin_reg)

redcued_interaction_wrkflw <- workflow() %>%
  add_recipe(reduced_2_recipe) %>%
  add_model(lin_reg)


full_tbl <- full_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

reduced_tbl <- reduced_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

reduced_interaction_tbl <- redcued_interaction_wrkflw %>%
  fit_resamples(resamples = whr_cvs) %>%
  collect_metrics()

bind_rows(
  full_tbl %>% mutate(model = "Full Model"),
  reduced_tbl %>% mutate(model = "Reduced Model"),
  reduced_interaction_tbl %>% mutate(model = "Reduced Interaction Model")
)
```

I decided that the reduced model was the best model. Although the reduced with
interactions as a slightly higher $R^2$ value, it is by less than .01 with a 
small reduction in RMSE. I did not select the full model even though it has a 
much smaller RMSE and a larger $R^2$ value because it has strongly correlated 
predictors.

## Part 3: Final Model

10. Summarize the results from your final model. Don't forget to fit your final model on the **full** dataset, even if you used *test / training* data or *cross-validation* during the model selection process.

```{r}
#| label: Q10

fit_model <- reduced_wrkflw %>%
  fit(whr_clean) %>%
  extract_fit_parsnip() 

fit_model %>%
  tidy() %>%
  kable()

fit_model %>%
  glance() %>% 
  kable()
```

GDP is the most important predictor outside of certain regional levels. This 
model has an $R^2$ value of 0.81, meaning that it accounts for 81% of the
variability in healthy life expectancy.

11. Include a plot of the residuals and discussion of what you see, and interpretations of the coefficients and metrics.

```{r}
#| label: Q11

whr_clean <- whr_clean %>%
  mutate(
    prediction = predict(reduced_wrkflw %>% fit(whr_clean), new_data = whr_clean)$.pred,
    residuals = healthy_life_expectancy - prediction
    )

whr_clean %>%
  ggplot(aes(x = healthy_life_expectancy, y = residuals)) +
    geom_point() +
    theme_bw()
```

The residual plot shows a bit of linear trend, which means a linear model is not
the best fit for this data.

- intercept:
- log_gdp_per_capita: 
- freedom_to_make_life_choices:
- generosity: 
- regional_indicator: 

# Predicting Life Expectancy -- K-Nearest-Neighbors

## Part 1: Tuning K

12. For **each** of your top three candidate models from Q8, find the best choice of **K**. Show all your work, and provide a brief summary at the end (e.g., "For Model 1, we choose a K of \[something\] because \[reasons\]. For Model 2, ...")

## Part 2: Best Model

13. Fit and report your single best model from Q9.

You should include:

-   An argument for your choice of K, including a plot.

-   A plot of the residuals

# Predicting on New Data

14. Use your **one** best *least-squares regression* model (Q9) to predict the life expectancy of all countries.

15. Use your **one** best *KNN* model (Q13) to predict the life expectancy of all countries.

16. Which model did a better job predicting the true values in the new data?

# Discussion Questions

## Parametric and Non-Parametric

17. Make an argument for why a **parametric** method, like least-squares regression, might be preferred in this task.

18. Then make an argument for why a **non-parametric** method, like K-Nearest-Neighbors, might be preferred.

## Interpretation and Prediction

19. If your only goal were **interpretation**, which of the candidate models (from *any* section of the assignment) would you have chosen? Why?

20. If your only goal were **prediction** on future data, which of the candidate models would you have chosen? Why?

## Standardization

21. Consider your final best least-squares regression model from Q9. Suppose we fit this model again, but this time, we normalize **all** of the quantitative variables. Will anything change? Give a (conceptual) argument for why this is true.

## Quantitative or Categorical?

22. Suppose we add the predictor `year` to our final model as a **categorical variable** and fit the model on all the data. Then, we use this new model to predict on the 2020 data. What is wrong with this plan?
