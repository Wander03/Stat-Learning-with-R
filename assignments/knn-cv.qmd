---
title: "Assignment 2: Cross-Validation and K-Nearest-Neighbors"
author: "Andrew Kerr"
format: 
  html:
    code-fold: true
    code-line-numbers: true
    code-tools: true
    embed-resources: true
editor: source
---

```{r}
#| label: packages
#| message: false
#| warning: false

set.seed(3849)

library(tidyverse)
library(tidymodels)
library(kableExtra)
```

# Instructions

Your document should also be clearly organized, so that it is easy for a reader to find your answers to each question. If I have a difficult time locating or reading your answer, you risk it being returned with a "revision requested".

# The Data

```{r}
#| label: load-data
#| message: false
whr_clean <- read_csv(here::here('data', 'whr_clean.csv'))

whr_clean <- whr_clean %>%
  mutate(
    regional_indicator = as_factor(regional_indicator)
  )

whr_clean %>% summary() %>% kable()
```

# Happiness Scores

## Part 1: Happiness Over Time

1.  Is the happiness in the world changing linearly over time? Fit a simple linear model and interpret the results to address this question.

```{r}
#| label: Q1

lin_reg <- linear_reg() %>%
  set_engine("lm") %>%
  set_mode("regression")

lr_m1 <- lin_reg %>%
  fit(happiness_score ~ year, data = whr_clean)

whr_clean <- whr_clean %>%
  mutate(
    prediction = predict(lr_m1, new_data = whr_clean)$.pred,
    residuals = happiness_score - prediction
    )

glance(lr_m1) %>% kable()
tidy(lr_m1) %>% kable()

whr_clean %>%
  ggplot(aes(x = happiness_score, y = residuals)) +
    geom_point() +
    theme_bw()
```

The happiness in the world is not changing linearly over time since we see a low $R^2$ value of approx. 0, and a large p-value for the year coefficient. Additionally, the residual plot shows a linear pattern, meaning we are using the wrong model.

2.  Was the happiness score approximately the same in all the years? Convert `year` to a factor variable, and fit a simple linear model to address this question.

```{r}
#| label: Q2

whr_clean <- whr_clean %>%
  mutate(year = as_factor(year))

lr_m2 <- lin_reg %>%
  fit(happiness_score ~ year, data = whr_clean)

tidy(lr_m2) %>% kable()
```

No, the happiness score was not approx. the same in all the years. We see highly significant p-values for all years compared to the baseline year of 2005, with 2005 being on average around 1 unit of happiness score greater than all the other years.

## Part 2: Happiness Equation

3.  How is each of the six measures of life quality weighted in calculating this score? Fit a model to estimate the weights, and interpret the coefficients.

```{r}
#| label: Q3

lr_recipe <- recipe(
  happiness_score ~ log_gdp_per_capita 
  + healthy_life_expectancy 
  + social_support 
  + freedom_to_make_life_choices 
  + generosity 
  + perceptions_of_corruption,
  data = whr_clean
  ) %>%
  step_normalize(all_numeric_predictors())

lr_wrkflw <- workflow() %>%
  add_recipe(lr_recipe) %>%
  add_model(lin_reg)

lr_wrkflw  %>%
  fit(whr_clean) %>%
  pull_workflow_fit()
```

-   intercept: When all predictors are at there minimum values, the average happiness score is 5.46.
-   log_gdp_per_capita: If log GDP per capita moves from its lowest observed value to its highest, the average happiness score increases by 0.41 units.
-   healthy_life_expectancy: Moving from the lowest observed life expectancy to the highest, the average happiness score increases by 0.23 units.
-   social_support: Moving from the lowest observed social support to the highest, the average happiness score increases by 0.27 units.
-   freedom_to_make_life_choices: If freedom to make life choices moves from its lowest observed value to its highest, the average happiness score increases by 0.15 units.
-   generosity: If the generosity of society moves from its lowest observed value to its highest, the average happiness score increases by 0.12 units.
-   perceptions_of_corruption: If perceptions of corruption in government moves from its lowest observed value to its highest, the average happiness score decreases by 0.12 units.

4.  Which measures of life quality does the WHR consider to be most important to a country's happiness?

Log GDP per capita is the most important to a country's happiness since it has the 
larges coefficient, followed by social support and healthy life expectancy.

# Predicting Life Expectancy -- Exploring Linear Models

```{r}
#| label: pred-life-expectancy

base_recipe <- recipe(
  healthy_life_expectancy ~ log_gdp_per_capita 
  + social_support 
  + freedom_to_make_life_choices 
  + generosity 
  + perceptions_of_corruption
  + regional_indicator,
  data = whr_clean
  )

life_wrkflw <- workflow() %>%
  add_recipe(base_recipe) %>%
  add_model(lin_reg)

life_wrkflw  %>%
  fit(whr_clean) %>%
  pull_workflow_fit() %>%
  tidy() %>%
  kable()
```


## Part 1: Summary of Approach

6.  Write a short description (bullet points are fine) of your process in narrowing down your model. How did you approach this problem, without spending hours upon hours fitting and cross-validating zillions of models?

## Part 2: Three Candidates

8.  Choose the three best candidate models among those you tried.

9.  Supply your code and results for comparing these models, and discuss how you decided which *one* model was the best one.

## Part 3: Final Model

10. Summarize the results from your final model. Don't forget to fit your final model on the **full** dataset, even if you used *test / training* data or *cross-validation* during the model selection process.

11. Include a plot of the residuals and discussion of what you see, and interpretations of the coefficients and metrics.

# Predicting Life Expectancy -- K-Nearest-Neighbors

## Part 1: Tuning K

12. For **each** of your top three candidate models from Q8, find the best choice of **K**. Show all your work, and provide a brief summary at the end (e.g., "For Model 1, we choose a K of \[something\] because \[reasons\]. For Model 2, ...")

## Part 2: Best Model

13. Fit and report your single best model from Q9.

You should include:

-   An argument for your choice of K, including a plot.

-   A plot of the residuals

# Predicting on New Data

14. Use your **one** best *least-squares regression* model (Q9) to predict the life expectancy of all countries.

15. Use your **one** best *KNN* model (Q13) to predict the life expectancy of all countries.

16. Which model did a better job predicting the true values in the new data?

# Discussion Questions

## Parametric and Non-Parametric

17. Make an argument for why a **parametric** method, like least-squares regression, might be preferred in this task.

18. Then make an argument for why a **non-parametric** method, like K-Nearest-Neighbors, might be preferred.

## Interpretation and Prediction

19. If your only goal were **interpretation**, which of the candidate models (from *any* section of the assignment) would you have chosen? Why?

20. If your only goal were **prediction** on future data, which of the candidate models would you have chosen? Why?

## Standardization

21. Consider your final best least-squares regression model from Q9. Suppose we fit this model again, but this time, we normalize **all** of the quantitative variables. Will anything change? Give a (conceptual) argument for why this is true.

## Quantitative or Categorical?

22. Suppose we add the predictor `year` to our final model as a **categorical variable** and fit the model on all the data. Then, we use this new model to predict on the 2020 data. What is wrong with this plan?
